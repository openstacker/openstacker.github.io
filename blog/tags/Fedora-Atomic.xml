<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:base="https://openstacker.github.io">
  <title>
    Blog  </title>
    <link href="https://openstacker.github.io/blog/tags/Fedora-Atomic.xml" rel="self" />
  
    <link href="https://openstacker.github.io/blog/"/>
  
    
  <updated>2018-10-01T14:16:13Z</updated>

  <id>https://openstacker.github.io/blog/tags/Fedora-Atomic.xml</id>

      <entry>
    <title type="html">Journey of Magnum to Production</title>
    <author><name>Feilong Wang</name></author>
    <link href="https://openstacker.github.io/blog/2018/magnum-to-production"/>
    <updated>2018-10-01T10:37:00Z</updated>
    <published>2018-10-01T10:37:00Z</published>
    <id>/blog/2018/magnum-to-production</id>
        <category   scheme="/blog/tags"
                term="Magnum"
                label="Magnum" />
        <category   scheme="/blog/tags"
                term="Fedora-Atomic"
                label="Fedora-Atomic" />
        <category   scheme="/blog/tags"
                term="Cloud-init"
                label="Cloud-Init" />
        <category   scheme="/blog/tags"
                term="Kubernetes"
                label="Kubernetes" />
    
    <content type="html">
                  &lt;p&gt;在上一篇&lt;a href=&#34;http://openstacker.github.io/blog/2018/magnum-architecture&#34;&gt;Magnum 入坑指南之一&lt;/a&gt;和&lt;a href=&#34;http://openstacker.github.io/blog/2017/magnum-2&#34;&gt;Magnum 入坑指南之二&lt;/a&gt;里
已经介绍了Magnum的基本安装和使用。这篇文章主要用来记录我们在将Magnum部署到生产环境时所遇到的问题，也好作为今年Berlin Summit的presentation 材料。&lt;/p&gt;
&lt;p&gt;到目前为止，我们在上prod/preprod的过程中遇到了两个问题。&lt;/p&gt;
&lt;h2&gt;anti-affinity policy&lt;/h2&gt;
&lt;p&gt;这个其实是我去年做的一个feature, 简单来说就是在创建k8s cluster时，将master节点和node节点放到一个server group里，然后设置server group的affinity policy 为soft-anti-affinity或者
anti-affinity, 从而使各个节点在schedule时能够被创建到不同的物理机上，避免node节点拥挤到一个节点上。&lt;/p&gt;
&lt;p&gt;但是我们的环境里暂时还不支持soft-anti-affinity, 这个我们实现没有测试到，还好可以直接在Magnum cluster show里面看到所以并没有浪费时间。&lt;/p&gt;
&lt;h2&gt;Cloud-init 的奇怪问题&lt;/h2&gt;
&lt;p&gt;接下来，我们遇到了cloud-init的问题。root cause说来也简单，就是我们的preprod太慢了，慢导致了很多问题，只不过各种问题的表象没有看起来那么直观。
回到我们所遇到的问题，Magnum所创建的instance无法注入keypair, 导致无法ssh到instance内debug。当然问题看起来很简单，公钥没有成功注入。接下来我们发现公钥没有注入的原因就是
cloud-init初始化就失败了。不得已，我又专门build了一个带用户名密码的 Fedora Atomic 镜像。重新创建 k8s cluster, 然后登录虚机，查看cloud-init.log 发现问题的根源在于
当 cloud-init 在试图和 Nova的metadata API连接时出现了超时，默认的timeout是5秒钟。通过查阅文档发现，可以通过更改/etc/cloud/cloud.cfg, 更改timeout时间，具体修改如下：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;datasource:&lt;br /&gt;  OpenStack:&lt;br /&gt;    metadata_urls: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&amp;#39;http://169.254.169.254:80&amp;#39;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;br /&gt;    dsmode: net&lt;br /&gt;    timeout: &lt;span class=&#34;m&#34;&gt;50&lt;/span&gt;&lt;br /&gt;    max_wait: &lt;span class=&#34;m&#34;&gt;120&lt;/span&gt;&lt;br /&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;br /&gt;
然而，这种方式并不能完全解决问题，具体看下面的log&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:16,875 - handlers.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: start: init-network/search-OpenStack: searching &lt;span class=&#34;k&#34;&gt;for&lt;/span&gt; network data from DataSourceOpenStack&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:16,875 - __init__.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: Seeing &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; we can get any data from &amp;lt;class &lt;span class=&#34;s1&#34;&gt;&amp;#39;cloudinit.sources.DataSourceOpenStack.DataSourceOpenStack&amp;#39;&lt;/span&gt;&amp;gt;&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:16,876 - url_helper.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;/1&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; open &lt;span class=&#34;s1&#34;&gt;&amp;#39;http://169.254.169.254:80/openstack&amp;#39;&lt;/span&gt; with &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;url&amp;#39;&lt;/span&gt;: &lt;span class=&#34;s1&#34;&gt;&amp;#39;http://169.254.169.254:80/openstack&amp;#39;&lt;/span&gt;, &lt;span class=&#34;s1&#34;&gt;&amp;#39;allow_redirects&amp;#39;&lt;/span&gt;: True, &lt;span class=&#34;s1&#34;&gt;&amp;#39;method&amp;#39;&lt;/span&gt;: &lt;span class=&#34;s1&#34;&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;, &lt;span class=&#34;s1&#34;&gt;&amp;#39;timeout&amp;#39;&lt;/span&gt;: &lt;span class=&#34;m&#34;&gt;50&lt;/span&gt;.0, &lt;span class=&#34;s1&#34;&gt;&amp;#39;headers&amp;#39;&lt;/span&gt;: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;User-Agent&amp;#39;&lt;/span&gt;: &lt;span class=&#34;s1&#34;&gt;&amp;#39;Cloud-Init/0.7.9&amp;#39;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}}&lt;/span&gt; configuration&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:28,873 - url_helper.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: Read from http://169.254.169.254:80/openstack &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;200&lt;/span&gt;, 50b&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; after &lt;span class=&#34;m&#34;&gt;1&lt;/span&gt; attempts&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:28,874 - DataSourceOpenStack.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: Using metadata source: &lt;span class=&#34;s1&#34;&gt;&amp;#39;http://169.254.169.254:80&amp;#39;&lt;/span&gt;&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:28,874 - url_helper.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;/6&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; open &lt;span class=&#34;s1&#34;&gt;&amp;#39;http://169.254.169.254:80/openstack&amp;#39;&lt;/span&gt; with &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;url&amp;#39;&lt;/span&gt;: &lt;span class=&#34;s1&#34;&gt;&amp;#39;http://169.254.169.254:80/openstack&amp;#39;&lt;/span&gt;, &lt;span class=&#34;s1&#34;&gt;&amp;#39;allow_redirects&amp;#39;&lt;/span&gt;: True, &lt;span class=&#34;s1&#34;&gt;&amp;#39;method&amp;#39;&lt;/span&gt;: &lt;span class=&#34;s1&#34;&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;, &lt;span class=&#34;s1&#34;&gt;&amp;#39;timeout&amp;#39;&lt;/span&gt;: &lt;span class=&#34;m&#34;&gt;5&lt;/span&gt;.0, &lt;span class=&#34;s1&#34;&gt;&amp;#39;headers&amp;#39;&lt;/span&gt;: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;User-Agent&amp;#39;&lt;/span&gt;: &lt;span class=&#34;s1&#34;&gt;&amp;#39;Cloud-Init/0.7.9&amp;#39;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}}&lt;/span&gt; configuration&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:33,885 - openstack.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: Unable to &lt;span class=&#34;nb&#34;&gt;read&lt;/span&gt; openstack versions from http://169.254.169.254:80 due to: HTTPConnectionPool&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;host&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;169.254.169.254&amp;#39;&lt;/span&gt;, &lt;span class=&#34;nv&#34;&gt;port&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;80&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;: Read timed out. &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;read&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;timeout&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;5&lt;/span&gt;.0&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:33,885 - openstack.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: Selected version &lt;span class=&#34;s1&#34;&gt;&amp;#39;latest&amp;#39;&lt;/span&gt; from &lt;span class=&#34;o&#34;&gt;[]&lt;/span&gt;&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:33,886 - url_helper.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;0&lt;/span&gt;/6&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; open &lt;span class=&#34;s1&#34;&gt;&amp;#39;http://169.254.169.254:80/openstack/latest/meta_data.json&amp;#39;&lt;/span&gt; with &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;url&amp;#39;&lt;/span&gt;: &lt;span class=&#34;s1&#34;&gt;&amp;#39;http://169.254.169.254:80/openstack/latest/meta_data.json&amp;#39;&lt;/span&gt;, &lt;span class=&#34;s1&#34;&gt;&amp;#39;allow_redirects&amp;#39;&lt;/span&gt;: True, &lt;span class=&#34;s1&#34;&gt;&amp;#39;method&amp;#39;&lt;/span&gt;: &lt;span class=&#34;s1&#34;&gt;&amp;#39;GET&amp;#39;&lt;/span&gt;, &lt;span class=&#34;s1&#34;&gt;&amp;#39;timeout&amp;#39;&lt;/span&gt;: &lt;span class=&#34;m&#34;&gt;5&lt;/span&gt;.0, &lt;span class=&#34;s1&#34;&gt;&amp;#39;headers&amp;#39;&lt;/span&gt;: &lt;span class=&#34;o&#34;&gt;{&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;User-Agent&amp;#39;&lt;/span&gt;: &lt;span class=&#34;s1&#34;&gt;&amp;#39;Cloud-Init/0.7.9&amp;#39;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;}}&lt;/span&gt; configuration&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:38,894 - openstack.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: Failed reading mandatory path http://169.254.169.254:80/openstack/latest/meta_data.json due to: HTTPConnectionPool&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;host&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&amp;#39;169.254.169.254&amp;#39;&lt;/span&gt;, &lt;span class=&#34;nv&#34;&gt;port&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;80&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;: Read timed out. &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;read&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;timeout&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;5&lt;/span&gt;.0&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:38,894 - util.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: Crawl of openstack metadata service took &lt;span class=&#34;m&#34;&gt;10&lt;/span&gt;.020 seconds&lt;br /&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-09-30 &lt;span class=&#34;m&#34;&gt;09&lt;/span&gt;:34:38,895 - handlers.py&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;DEBUG&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;: finish: init-network/search-OpenStack: SUCCESS: no network data found from DataSourceOpenStack&lt;br /&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;br /&gt;
这个timeout 只对第一个request 起了作用，后面的request仍然是按照 5 秒钟作为timeout。我研究到这里的时候已经后半夜两点了，不想再研究只对第一个request 起作用了，所以我决定直接改代码。&lt;/p&gt;
&lt;p&gt;然而我发现在 Fedora Atomic, 即使你是root 用户，也是不能直接修改 cloud-init的代码的，这部分代码是只读的。&lt;/p&gt;
&lt;p&gt;要修改这部分只读的代码，需要先知道当前deploy的host status, 可以通过如下命令获得：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;fedora@k8s-cluster-1-adbneq5un4ok-master-0 log&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;$ sudo atomic host status&lt;br /&gt;State: idle&lt;br /&gt;Deployments:&lt;br /&gt;* fedora-atomic:fedora/27/x86_64/atomic-host&lt;br /&gt;                   Version: &lt;span class=&#34;m&#34;&gt;27&lt;/span&gt;.81 &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;m&#34;&gt;2018&lt;/span&gt;-02-12 &lt;span class=&#34;m&#34;&gt;17&lt;/span&gt;:50:48&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;&lt;br /&gt;                    Commit: b25bde0109441817f912ece57ca1fc39efc60e6cef4a7a23ad9de51b1f36b742&lt;br /&gt;              GPGSignature: Valid signature by 860E19B0AFA800A1751881A6F55E7430F5282EE4&lt;br /&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;br /&gt;
接下来再通过上面命令得到的commit ID, 通过chroot 命令切换到相应的commit下，这时候就可以读写了。&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;root@fedora-atomic-27-x86_64 log&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;c1&#34;&gt;# chroot /sysroot/ostree/deploy/fedora-atomic/deploy/b25bde0109441817f912ece57ca1fc39efc60e6cef4a7a23ad9de51b1f36b742.0/&lt;/span&gt;&lt;br /&gt;bash-4.4# vi /usr/lib/python3.6/site-packages/cloudinit/url_helper.py &lt;br /&gt;bash-4.4# &lt;span class=&#34;nb&#34;&gt;exit&lt;/span&gt;&lt;br /&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;br /&gt;
未完待续&lt;/p&gt;      
          </content>
  </entry>
  

</feed>